<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/transaction.css" />
	<link rel="stylesheet" type="text/css" href="css/footer.css" />
	<link rel="stylesheet" type="text/css" href="css/common.css" />
	<link rel="stylesheet" type="text/css" href="lib/bootstrap.min.css" />
	<style>
		.entrust{
				margin-bottom:57px;
			}
			.addplus img{width: 20px;}
			th {text-align: center};
			.list_ul li{
				padding: 5px 0;
			}
			.tab-item{
				border-bottom: 2px solid #fff;
				padding: 3px 0;	
			}
			.tab-active{
				border-bottom: 2px solid #02c289;
			}
			.limit img{
				width: 20px;
			}
			
		</style>
</head>

<body>
	<div id="header">
		<div>
			<p class="pull-left sideOpen">
				<img src="images/list.png" />
				<span><span class="legal_name"></span>/<span class="currency_name"></span></span>
			</p>
			<p class="pull-right">
				<!-- <img src="images/share.png"/ class="share" onclick="location.href='LeveragedAccounts.html'"> -->
				<!-- <img src="images/collect.png" class="collect" /> -->
				<a href="dataMap.html">
					<img src="images/datamap.png" />
				</a>
			</p>
		</div>
		<!-- <ul>
				<li>
					<strong>0.00000000</strong>
					<span>可用USDT</span>
				</li>
				<li>
					<strong>0.00000000</strong>
					<span>可用USDT</span>
				</li>
				<li>
					<strong>0.00000000</strong>
					<span>爆仓价</span>
				</li>
			</ul> -->
		<!-- <p>
				分享率一一
				<img src="images/query.png"/>
			</p> -->
	</div>
	<!-- <hr class="hr"/> -->
	<div id="data">
		<div class="pull-left active">
			<div class="deal">
				<span class="pull-left buy">
					<a>买入</a>
					<em></em>
				</span>
				<span class="sell">
					<a>卖出</a>
				</span>
			</div>
			<div class="LimitedPrice">
				<p class="limitedprice">
					限价
					<img src="images/pulldown.png" />
				</p>
				<ul class="Price" style="display:flex;">
					<!-- <li class="price_num">6919.90</li> -->
					<input type="number" class="price_num" value="1" style="width:100px;  padding-left:10px;" />
					<li class="addplus">
						<span class="subtract">
							<img src="images/jian.png" />
						</span>
						<span>|</span>
						<span class="plus">
							<img src="images/add.png" />
						</span>
					</li>
				</ul>
				<h6>
					≈6919.90CNY
				</h6>
				<p class="num">
					<label style="display:flex;height:100%;justify-content: center;">
						<input type="number" placeholder="请输入数量" class="account" style="width:150px;color: #333;font-weight: normal;width: 150px;font-size: 14px;" />
						<span class="lge_name">BTC</span>
					</label>
				</p>
				<!-- <ul class="Btc">
						<li>
							<span class="absolute">
								<i ></i>
							</span>
						</li>
						<li class="width">
							<a></a>
							<span class="absolute">
								<i></i>
							</span>
						</li>
						<li class="width">
							<a></a>
							<span class="absolute">
								<i></i>
							</span>
						</li>
						<li class="width">
							<a></a>
							<span class="absolute">
								<i></i>
							</span>
						</li>
						<li class="width">
							<a></a>
							<span class="absolute">
								<i></i>
							</span>
						</li>
					</ul> -->
				<p class="p">
					<span class="all_account">0</span>
					<span class="pull-right legal_sp">BTC</span>
				</p>
			</div>
			<div class="transactionAmount">
				<p>交易额</p>
				<button class="buy_in">买入<span class="btn_name">BTC</span></button>
			</div>
		</div>
		<div class="pull-right active1">
			<!--卖出-->
			<div class="ft10 color1">
				<div class="flex alcenter pb10">
					<div class="flex1 tl">盘口</div>
					<div class="flex2 tr">价格</div>
					<div class="flex2 tr">数量</div>
				</div>
				<div>
					<div class="sell_out">
						<div class="flex alcenter pb10">
							<div class="flex1 tl">5</div>
							<div class="red flex2 tr">6919.90</div>
							<div class="flex2 tr">0.689</div>
						</div>
						<div class="flex alcenter pb10">
							<div class="flex1 tl">4</div>
							<div class="red flex2 tr">6919.90</div>
							<div class="flex2 tr">0.689</div>
						</div>
						<div class="flex alcenter pb10">
							<div class="flex1 tl">3</div>
							<div class="red flex2 tr">6919.90</div>
							<div class="flex2 tr">0.689</div>
						</div>
						<div class="flex alcenter pb10">
							<div class="flex1 tl">2</div>
							<div class="red flex2 tr">6919.90</div>
							<div class="flex2 tr">0.689</div>
						</div>
						<div class="flex alcenter pb10">
							<div class="flex1 tl">1</div>
							<div class="red flex2 tr">6919.90</div>
							<div class="flex2 tr">0.689</div>
						</div>
					</div>
					<p style="color:#de5959;font-size:18px;" class="new_price"></p>
					<p>≈6919.90CNY</p>
				</div>
			</div>
			<!--买入-->
			<div class="ft10 color1">
				<div class="buyIn">
					<div class="flex alcenter pb10">
						<div class="flex1 tl">5</div>
						<div class="gre flex2 tr">6919.90</div>
						<div class="flex2 tr">0.689</div>
					</div>
					<div class="flex alcenter pb10">
						<div class="flex1 tl">4</div>
						<div class="gre flex2 tr">6919.90</div>
						<div class="flex2 tr">0.689</div>
					</div>
					<div class="flex alcenter pb10">
						<div class="flex1 tl">3</div>
						<div class="gre flex2 tr">6919.90</div>
						<div class="flex2 tr">0.689</div>
					</div>
					<div class="flex alcenter pb10">
						<div class="flex1 tl">2</div>
						<div class="gre flex2 tr">6919.90</div>
						<div class="flex2 tr">0.689</div>
					</div>
					<div class="flex alcenter pb10">
						<div class="flex1 tl">1</div>
						<div class="gre flex2 tr">6919.90</div>
						<div class="flex2 tr">0.689</div>
					</div>
				</div>
				<div>
					<span class="pull-right limit">
						额度1
						<img src="images/pulldown.png" style="width:20px;" />
					</span>
				</div>
			</div>
		</div>
	</div>
	<div id="mask1">
		<div id="Limited">
			<ul>
				<li></li>
				<li class="cancel">取消</li>
			</ul>
		</div>
	</div>
	<hr class="hr" />
	<!-- <div id="entrust">
			<div>
				<h3 class="pull-left">
					当前委托
				</h3>
				<p class="pull-right filtrate" onclick="location.href='Entrust.html'"> 
					<img src="images/record1.png"/>
					<span>
						全部
					</span>
				</p>					
			</div>
			<div>
				<p>
					<img src="images/anonymous.png"/>
				</p>
				<p>暂无记录</p>
			</div>
		</div>		 -->
	<div id="sideColumn">
		<h4>
			<span class="side">HBG</span>
			<img src="images/datamap.png" class="pull-right sideclose" />
		</h4>
		<ol class="legal bdb">
			<!-- <li>自选</li>
			<li class="side">USDT</li>
			<li>BTC</li> -->
		</ol>
		<ul class="ul">
		</ul>
	</div>
	    <div class="bar" style="margin-bottom:60px;">
		<ul class="flex ft14 plr10 bdb" style="margin-bottom:0;">
			<li class="flex1 tl tab-item ft16 bold">全站交易</li>
		</ul>
		<ul class="list_ul">
			<li class="flex around" style="padding:5px 0;">
				<span class="flex1 tc">时间</span>
				<span class="flex1 tc">价格</span>
				<span class="flex1 tc">交易量</span>
			</li>
			<div class="conplete_list">
				<li class="flex around" style="padding:5px 0;">
					<span class="flex1 tc">12:00:04</span>
					<span class="flex1 tc">0.052554BTC</span>
					<span class="flex1 tc">0.0044</span>
				</li>
				<li class="flex around" style="padding:5px 0;">
					<span class="flex1 tc">12:00:04</span>
					<span class="flex1 tc">0.052554BTC</span>
					<span class="flex1 tc">0.0044</span>
				</li>
			</div>
		</ul>
	</div>
	<footer>
		<a href="index.html">
			<div>
				<p class="img img0"></p>
				<span>首页</span>
			</div>
		</a>
		<a href="market.html">
			<div>
				<p class="img img1"></p>
				<span>行情</span>
			</div>
		</a>
		<a href="transaction.html" class="select">
			<div>
				<p class="img img2"></p>
				<span>交易</span>
			</div>
		</a>
		<a href="#" class="onc">
			<div>
				<p class="img img3"></p>
				<span>杠杆交易</span>
			</div>
		</a>
		<a href="personal.html">
			<div>
				<p class="img img4"></p>
				<span>我的</span>
			</div>
		</a>
	</footer>
	<script type="text/javascript" src="lib/jquery-2.1.1.min.js"></script>
	<script src="javascripts/jquery.cookie.js"></script>
	<script type="text/javascript" src="javascripts/transaction.js"></script>
	<script src="lib/layer_mobile/layer.js"></script>
	<script src="javascripts/main.js"></script>
	<script src="https://cdn.bootcss.com/socket.io/1.3.7/socket.io.js"></script>
	<script type="text/javascript">
	 
     	var res0;
		$('.ul').css('display', 'block')
		$('.tab-item').click(function () {
			$(this).addClass('tab-active').siblings().removeClass('tab-active');
		})
		//===============币种======================
		var token = get_user_login();
		$('.plus').click(function(){
			$('.all_account').text($('.price_num').val() * $('.account').val())
		});
		$('.addplus').click(function(){
			$('.all_account').text($('.price_num').val() * $('.account').val())
		})
		$('.price_num').keyup(function () {
			$('.all_account').text($('.price_num').val() * $('.account').val())
		})
		$('.account').keyup(function () {
			$('.all_account').text($('.price_num').val() * $('.account').val())
		})
		$.ajax({
			type: 'get',
			url: _API + 'currency/quotation',
			dataType: 'json',
			beforeSend: function beforeSend(request) {
				request.setRequestHeader("Authorization", token);
			},

			success: function (res) {
				console.log(res);
				if (res.type == 'ok') {
					 res0 = res;
					//法币赋值
					var html = '';
					var currency_html = '';
					for (var i = 0; i < res.message.length; i++) {
						html += `
						<li class='color1' data-id='${res.message[i].id}'>${res.message[i].name}</li>
						`;
						if (i == 1) {
							for (var j = 0; j < res.message[i].quotation.length; j++) {
								currency_html += `
							<li class='bdb legal_li sideclose'>
								<strong class="strong_name" data-id='${res.message[i].quotation[j].id}'>${res.message[i].quotation[j].name}</strong>
								<p class="${parseFloat(res.message[i].quotation[j].proportion) < 0 ? 'fontC' : 'gre'}">
									<span class="">${res.message[i].quotation[j].last_price}</span>
									<span class="pull-right ">${parseFloat(res.message[i].quotation[j].proportion) >= 0 ? '+' + res.message[i].quotation[j].proportion + '%' : '-' + res.message[i].quotation[j].proportion + '%'}</span>
								</p>
							</li>
							`
							}
						}
					};

					$('.legal').html(html);
					$('.legal li').eq(1).addClass('side side2');
					$('.ul').html(currency_html);

					//币种赋值
					
					//默认选中的币种
					$('.legal_li').eq(0).css('background', '#f8f8f8');
					//标题赋值
					$('.legal_name').text($('.strong_name').eq(0).text()).data('id', $('.strong_name').eq(0).data('id'));
					$('.currency_name').text($('.legal li').eq(1).text()).data('id', $('.legal li').eq(1).data('id'));
					$('.lge_name').text($('.legal_name').text());
					$('.legal_sp').text($('.legal_name').text());
					$('.btn_name').text($('.legal_name').text());
					//初始化交易数据渲染
					$.ajax({
						type: 'post',
						url: _API + 'transaction/deal',
						data: {
							legal_id: $('.legal_name').data('id'),
							currency_id: $('.currency_name').data('id')
						},
						dataType: 'json',
						beforeSend: function beforeSend(request) {
							request.setRequestHeader("Authorization", token);
						},
						success: function (res) {
							console.log(res);
							if (res.type == 'ok') {
								var out = res.message.out;
								var buyIn = res.message.in;
								var sell_list = '';
								var buy_list = '';
								$.each(out, function (k, v) {
									sell_list += `
										<div class="flex alcenter pb10">
											<div class="flex1 tl">${k + 1}</div>
											<div class="red flex2 tr">${v.price}</div>
											<div class="flex2 tr">${v.number}</div>
										</div>
										`
								});
								$.each(buyIn, function (k, v) {
									buy_list += `
										<div class="flex alcenter pb10">
											<div class="flex1 tl">${k + 1}</div>
											<div class="gre flex2 tr">${v.price}</div>
											<div class="flex2 tr">${v.number}</div>
										</div>
										`
								});
								$('.sell_out').html(sell_list);
								$('.buyIn').html(buy_list);
								$('.new_price').text(res.message.last_price);
								//全部交易
								var complete_list = '';
								$.each(res.message.complete, function (k, v) {
									complete_list += `
										<li class="flex around" style="padding:5px 0;">
											<span class="flex1 tc">${v.time}</span>
											<span class="flex1 tc">${v.price}</span>
											<span class="flex1 tc">${v.number}</span>
										</li>
										`
								});
								$('.conplete_list').html(complete_list);
								scoket();
							}
						}
					});
										
				};
			}
		});
		//币种切换
		$('body').on('click','.legal_li',function () {
						$(this).css('background', '#f8f8f8').siblings().css('background', 'none');
						$('.legal_name').text($(this).find('strong').text());
						$('.currency_name').text($('.side2').text());
						$('.legal_name').data('id', $(this).find('strong').data('id'));
						$('.currency_name').data('id', $('.side2').data('id'));
						$('.lge_name').text($(this).find('strong').text());
						$('.legal_sp').text($(this).find('strong').text());
						$('.btn_name').text($(this).find('strong').text())
						close();
						//交易数据渲染
						$.ajax({
							type: 'post',
							url: _API + 'transaction/deal',
							data: {
								legal_id: $('.legal_name').data('id'),
								currency_id: $('.currency_name').data('id')
							},
							dataType: 'json',
							beforeSend: function beforeSend(request) {
								request.setRequestHeader("Authorization", token);
							},
							success: function (res) {
								console.log(res);
								if (res.type == 'ok') {
									var out = res.message.out;
									var buyIn = res.message.in;
									var sell_list = '';
									var buy_list = '';
									$.each(out, function (k, v) {
										sell_list += `
										<div class="flex alcenter pb10">
											<div class="flex1 tl">${k + 1}</div>
											<div class="red flex2 tr">${v.price}</div>
											<div class="flex2 tr">${v.number}</div>
										</div>
										`
									});
									$.each(buyIn, function (k, v) {
										buy_list += `
										<div class="flex alcenter pb10">
											<div class="flex1 tl">${k + 1}</div>
											<div class="gre flex2 tr">${v.price}</div>
											<div class="flex2 tr">${v.number}</div>
										</div>
										`
									});
									$('.sell_out').html(sell_list);
									$('.buyIn').html(buy_list);
									$('.new_price').text(res.message.last_price);
									//全部交易
									var complete_list = '';
									$.each(res.message.complete, function (k, v) {
										complete_list += `
										<li class="flex around" style="padding:5px 0;">
											<span class="flex1 tc">${v.time}</span>
											<span class="flex1 tc">${v.price}</span>
											<span class="flex1 tc">${v.number}</span>
										</li>
										`
									});
									$('.conplete_list').html(complete_list);
									scoket();
								}
							}
						});
						
					});
					//点击法币切换
					$('.legal').on('click','li',function () {
						$(this).addClass('side side2').siblings().removeClass('side side2');

						currency_html = '';
						var n = $(this).index();
						for (var i = 0; i < res0.message.length; i++) {
							if (i == n) {
								for (var j = 0; j < res0.message[i].quotation.length; j++) {
									currency_html += `
							<li class='bdb legal_li sideclose'>
								<strong class="strong_name" data-id='${res0.message[i].quotation[j].id}'>${res0.message[i].quotation[j].name}</strong>
								<p class="${parseFloat(res0.message[i].quotation[j].proportion) < 0 ? 'fontC' : 'gre'}">
									<span class="">${res0.message[i].quotation[j].last_price}</span>
									<span class="pull-right ">${parseFloat(res0.message[i].quotation[j].proportion) >= 0 ? '+' + res0.message[i].quotation[j].proportion + '%' : '-' + res.message[i].quotation[j].proportion + '%'}</span>
								</p>
							</li>
							`
								}
							}
						};
						$('.ul').html(currency_html);						
					});
		//买入、卖出
		$('.buy_in').click(function () {
						if ($('.account').val() == '') {
							layer_msg('请填写数量')
						} else {
							//买入
							if ($('.buy a').attr('class') == 'col') {

								$.ajax({
									url: _API + 'transaction/in',
									type: 'post',
									data: {
										price: $('.price_num').val(),
										num: $('.account').val(),
										legal_id: $('.legal_name').data('id'),
										currency_id: $('.currency_name').data('id')
									},
									dataType: 'json',
									beforeSend: function beforeSend(request) {
										request.setRequestHeader("Authorization", token);
									},
									success: function (res) {
										console.log(res);
										layer_msg(res.message)
									}
								})

								//卖出
							} else if ($('.sell a').attr('class') == 'col') {
								console.log('卖出')
								$.ajax({
									url: _API + 'transaction/out',
									type: 'post',
									data: {
										price: $('.price_num').val(),
										num: $('.account').val(),
										legal_id: $('.legal_name').data('id'),
										currency_id: $('.currency_name').data('id')
									},
									dataType: 'json',
									beforeSend: function beforeSend(request) {
										request.setRequestHeader("Authorization", token);
									},
									success: function (res) {
										console.log('pppppp')
										console.log(res);
										layer_msg(res.message)
									}
								})
							}
						}
					})
	    //关闭左侧弹层				
		function close() {
			$('body').css('overflow', 'auto');
			$('#Limited').show();
			$('#mask1').hide();
			$('#sideColumn').animate({
				left: '-80%'
			}, 1000);
		}
		//socket连接封装
      function scoket(){
		  console.log('ppp')
		$.ajax({
			url: _API + "user/info",
			type: "GET",
			dataType: "json",
			async: true,
			beforeSend: function beforeSend(request) {
				request.setRequestHeader("Authorization", token);
			},
			success: function success(data) {
				console.log(data);
				if (data.type == 'ok') {
					var socket = io(socket_api);
					socket.on('connect', function (datas) {
						socket.emit('login', data.message.id);
						// 后端推送来消息时
						socket.on('transaction', function (msg) {
							console.log(msg);
							if (msg.type == 'transaction') {
								var sell_list = '';
								var buy_list = '';
								var buyIn = JSON.parse(msg.in);
								var out = JSON.parse(msg.out);
								$.each(out, function (k, v) {
									sell_list += `
										<div class="flex alcenter pb10">
											<div class="flex1 tl">${k + 1}</div>
											<div class="red flex2 tr" style="margin-right:5px;">${v.price}</div>
											<div class="flex2 tr">${v.number}</div>
										</div>
										`
								});
								$.each(buyIn, function (k, v) {
									buy_list += `
										<div class="flex alcenter pb10">
											<div class="flex1 tl">${k + 1}</div>
											<div class="gre flex2 tr" style="margin-right:5px;">${v.price}</div>
											<div class="flex2 tr">${v.number}</div>
										</div>
										`
								});
								$('.sell_out').html(sell_list);
								$('.buyIn').html(buy_list);
							}

						})
					})
				}
			}
		});
	  }
		


   $('.onc').click(function(){
            layer_msg("暂未开放")
        })


	</script>
	
</body>

</html>