<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>行情</title>
	<link rel="stylesheet" type="text/css" href="static/css/market.css" />
	<link rel="stylesheet" type="text/css" href="static/css/footer.css" />
	<link rel="stylesheet" href="http://at.alicdn.com/t/font_766828_rcl48dsu2eq.css">
	<script type="text/javascript" src="static/javascripts/jquery.min.js"></script>
	<script src="static/javascripts/jquery.cookie.js"></script>
	<script src="static/lib/layer_mobile/layer.js"></script>
	<script src="static/javascripts/main.js"></script>
	<script src="static/javascripts/imtoken/flexble.js"></script>
	<script src="https://cdn.bootcss.com/socket.io/1.3.7/socket.io.js"></script>
	<style>
		.header{
			position:fixed;
			left:0;
			top:0;
			width:100%;
			box-sizing:border-box;
			display: flex;
			height:45px;
			align-items:center;
			z-index: 10;
			background-color: #37bac9;
			font-size: 16px;
		}
		.header .back {
			position: absolute;
			top: 50%;
			-webkit-transform: translateY(-50%);
			-moz-transform: translateY(-50%);
			-ms-transform: translateY(-50%);
			-o-transform: translateY(-50%);
			transform: translateY(-50%);
			left: 0.4000rem;
			height: 20px;
			width: 20px;
			background: url("static/images/imtoken/back_white.png");
			background-size: cover;
		}
		.header h5{
			margin: 0 auto;
			color: #fff;
		}
		.legal_wrap {
			padding-top: 90px;
			border-bottom: 1px solid #EBEBEB;
		}
		.scroll{
			position: fixed;
			top: 45px ;
			left: 0;
			width: 100%;
			height: 45px;
			z-index: 100;
			background: #fff ;
			z-index: 1;
		}
		.wrap-tab ul{
			border-bottom: 1px solid #EBEBEB;
			height: 45px;
			width: 90%;
			margin:  0 auto;
			display: flex;
			overflow-x: scroll;
		}
		.wrap-tab ul li {
			font-size: 16px;
			color: #9DA8AE;
			height: 40px;
			line-height: 40px;
			letter-spacing: -1px;
			text-align: center;
			width: 25%;
			float: left;
		}

		.wrap-main-two {
			margin-bottom: 55px;
		}
		body{
			background: #fff;
		}
		.legal_ul{
			background: #fff;
		}
		.wrap-tab ul li {
			color: #9DA8AE;
		}
		.name_2{
			color: #9DA8AE;
		}
		.name_1 h5 {
			color: #1A384A;
		}
		.name_1 span{
			color: #C9CDCC;
		}
		.main-price .name_1 {
			color: #1A384A;
		}
		.scroll>ul{
			display: none;
		}
		.scroll>ul.active{
			display: block;
		}
		.wrap-cont>.inContent{
			display: none;
		}
		.wrap-cont>.inContent.active{
			display: block;
		}
		.main-type {
			position: fixed;
			width: 80%;
			left: 10%;
			top:10px;
			/* height: 30px; */
			border:1px solid #9DA8AE;
			border-radius: 2px;
			color: #1A384A;
			display: flex;
			align-items: center;
			background-color: #fff;
		}
		.main-type>div{
			text-align: center;
			flex: 1;
			line-height: 30px;
			border-right: 1px solid #9DA8AE;
		}
		.main-type>div:last-child{
			border:none;
		}
		.main-type>div.active{
			color: #fff;
			background-color: #5a8de0;
		}
		.fixed_box{
			height: 90px;
			background-color: #fff;
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
		}
	</style>
</head>
<body>
	<div class="wrap-tab" id="content">
		<div class="wrap-table info">
			<div class="fixed_box">
					<div class="header">
						<h5>行情</h5>
					</div>
				<div class="scroll">
						<ul class="legal_ul active">
							
						</ul>
						<ul class="legal_ul1">
							
						</ul>
						<ul class="legal_ul2">
							
						</ul>
				</div>
						
			</div>
			<div class="wrap-cont">
				<div class="inContent active">
					<div class="wrap-main-two legal_wrap">

					</div>
				</div>
				 <div class="inContent">

					<div class="wrap-main">

					</div>


				</div>
				<div class="inContent">

					<div class="wrap-main">

					</div>

				</div>
				<!--<div class="inContent">

					<div class="wrap-main">

					</div>

				</div>
				<div class="inContent">

					<div class="wrap-main">

					</div>

				</div> -->
			</div>
		</div>
		<!-- <div class="wrap-table info">
			<ul>
				
			</ul>
			<div class="wrap-cont">
				<div class="inContent" style="padding-top: 42px;">

				</div>
				<div class="inContent">

					<div class="wrap-main">

					</div>

				</div>
				<div class="inContent">

					<div class="wrap-main">

					</div>
					
				</div>
				<div class="inContent">

					<div class="wrap-main">

					</div>

				</div>
			</div>
		</div> -->
	</div>
	<div class="common_footer">
        <a href="index.html"><i class="icon-size iconfont icon-chanyeguimo"></i>资产</a>
        <a href="market.html" class="active"><i class="icon-size iconfont icon-hangqing"></i>行情</a>
        	<!-- <a href="deal.html" ><i class="icon-size iconfont icon-shuffle__easy"></i>交易</a> -->
        <a href="fiatrad.html" ><i class="icon-size iconfont icon-navjiaoyizhongxin"></i>C2C</a>
        <a href="userinfo.html" ><i class="icon-size iconfont icon-wo"></i>我的</a>
</div>
	<script>
		$(function () {
			var datas;
			var token = get_user_login();
			var currentLegalId=''.cnyprice;
			var cny;
			$.ajax({
				url: laravel_api + '/currency/quotation',
				type: 'get',
				dataType: 'json',
				beforeSend: function beforeSend(request) {
					request.setRequestHeader("Authorization", token);
				},
				success: function (res) {
					console.log(res);
					if (res.type == 'ok') {
						datas = res.message;
						var legal_html = '';
						var msg = res.message;
						
						console.log(msg)
						
						for (var i = 0; i < msg.length; i++) {
							// cnyprice=msg[0].cny_price-0;
							legal_html += `
									<li data-id='${msg[i].id}' data-cnyprice='${msg[i].cny_price}'>
										<h5>${msg[i].name}</h5>
									</li>
							`;
							if (i == 0) {
								currentLegalId=msg[0].id;
								console.log(currentLegalId,123)
								socket(token);
								render(msg[i])
							}
						};
						//法币赋值
						$('.legal_ul').html(legal_html);
						$(".info li:first").addClass("wrap-btm").siblings().addClass("old");
						$("#content div:first").show().siblings().hide();
						$(".inContent:first").show().siblings().hide();
					}
				}
			});
			
			$('.onc').click(function () {
				layer_msg("暂未开放")
			});

			$("#title li").click(function () {
				$(this).addClass("wrap-title").removeClass("old").siblings().addClass("old").removeClass("wrap-title");
				$(".info ").hide().eq($("#title li").index(this)).show();
				//$(".info div:first-child").show().siblings().hide();
				$(".info div:first-child").filter(".inContent").show().siblings().hide();
				$(".info li:first-child").addClass("wrap-btm").removeClass("old").siblings().addClass("old").removeClass(
					"wrap-btm");
			});

			//法币切换
			$('.info').on('click', 'li', function () {
				console.log(datas);
				var arr_list = '';
				var idx = $(this).index();
				currentLegalId=$(this).data('id')
				// cnyprice=$(this).data('cnyprice')-0;
				console.log(idx)
				$(this).addClass("wrap-btm").removeClass("old").siblings().addClass("old").removeClass("wrap-btm");
				// $(".inContent").hide().eq($(".info li").index(this)).show();
				$.each(datas, function (k, v) {
					if (idx == k) {
						console.log(idx);
						console.log(k);
						render(datas[k])
					}
				});
				console.log(currentLegalId)
				
			});
			function render(msg){
				var currency_html = '';
				 cnyprice=msg.cny_price-0;
				//  var names=['ETH','BTC','BKBC'];
				$.each(msg.quotation, function (k, v) {
					// var statu=$.inArray(v.currency_name, names);
					// console.log($.inArray(v.currency_name, names),v.currency_name)
					currency_html += `
						<a href="javascript:;" class="main-asset " data-currentId="${v.currency_id}">
							<div class="main-name">
								<div class="name_1">
									<h5>${v.name}</h5>
									<span>/${msg.name}</span>
								</div>
									<!--<div class="name_2">
									24H量
									<span class='volume'>${((v.volume || 0) - 0).toFixed(0)}</span>
								</div>-->
							</div>
							<div class="main-price">
								<div class="name_1 usdprice">${v.now_price || '0.00'}</div>
								<div class="name_2 cnyprice">¥${(v.now_price * cnyprice ).toFixed(2) || '0.00'}</div>
							</div>
							<div class="main-rate">
								<div class="rate_green" style="background:${(v.change - 0) >= 0 ? '#02BF85' : '#E56C41'}">${v.change ?(v.change-0).toFixed(3) : '+0.000'}%</div>
							</div>
						</a>
						`
				});
				$('.legal_wrap').html(currency_html);
			}
			//socket连接封装
			function socket(token) {
				$.ajax({
					url: laravel_api + "/user/info",
					type: "GET",
					dataType: "json",
					async: true,
					beforeSend: function beforeSend(request) {
						request.setRequestHeader("Authorization", token);
					},
					success: function success(data) {
						console.log(data);
						if (data.type == 'ok') {
							var socket = io(socket_api);
							socket.on('connect', function (datas) {
								socket.emit('login', data.message.id);
								// 后端推送来消息时
								socket.on('daymarket', function (msg) {
									console.log(msg);
									if (msg.type == 'daymarket') {
										if(currentLegalId&&(currentLegalId==msg.legal_id)){
											// now_price
											var $currentTag=$('.legal_wrap a[data-currentId='+msg.currency_id+']');
											// console.log($currentTag,'---------------')
											$currentTag.find('.volume').text(((msg.volume || 0) - 0).toFixed(0))
											$currentTag.find('.usdprice').text(msg.now_price || '0.00')
											$currentTag.find('.cnyprice').text('￥'+((msg.now_price *cnyprice).toFixed(2)|| '0.00'))
											$currentTag.find('.main-rate').html(`<div class="rate_green" style="background:${(msg.change - 0) >= 0 ? '#02BF85' : '#E56C41'}">${msg.change ? msg.change : '+0.000'}%</div>`)
										}
									}
								});
							});
						}
					}
				});
			}
			$('.main-type>div').click(function(){
				var index=$(this).index();
				$(this).addClass('active').siblings().removeClass('active');
				$('.scroll>ul').eq(index).addClass('active').siblings().removeClass('active')
				$('.wrap-cont>div').eq(index).addClass('active').siblings().removeClass('active');
			})
			$('body').on('click','.main-asset.notopen',function(){
				layer_msg('暂未开放');
				// alert(123);
				return false;
			})
		});
		
	</script>
</body>

</html>